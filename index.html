<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #f8fafc;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --user-message-bg: #6366f1;
            --assistant-message-bg: #f1f5f9;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .app-header {
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background-color: var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .app-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .app-subtitle {
            font-size: 0.75rem;
            color: #64748b;
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-demo {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-connected {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .sidebar {
            width: 260px;
            background-color: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .new-chat-btn {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        
        .new-chat-btn:hover {
            background-color: #5558e3;
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .chat-history-item {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
        }
        
        .chat-history-item:hover {
            background-color: #f1f5f9;
        }
        
        .chat-history-item.active {
            background-color: #eef2ff;
            color: var(--primary-color);
        }
        
        .chat-history-icon {
            color: #94a3b8;
        }
        
        .chat-history-title {
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 15px 20px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title {
            font-weight: 500;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .model-selector {
            background-color: #f1f5f9;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .action-btn:hover {
            background-color: #f1f5f9;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #fafbfc;
        }
        
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }
        
        .welcome-icon {
            width: 80px;
            height: 80px;
            background-color: #eef2ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 2rem;
        }
        
        .welcome-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .welcome-description {
            color: #64748b;
            max-width: 500px;
            margin-bottom: 30px;
        }
        
        .feature-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 800px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .feature-icon {
            width: 40px;
            height: 40px;
            background-color: #eef2ff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .feature-title {
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .feature-description {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
        }
        
        .user .message-content {
            background-color: var(--user-message-bg);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .assistant .message-content {
            background-color: var(--assistant-message-bg);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            flex-shrink: 0;
        }
        
        .user .message-avatar {
            background-color: var(--user-message-bg);
            color: white;
        }
        
        .assistant .message-avatar {
            background-color: var(--assistant-message-bg);
            color: var(--text-color);
        }
        
        .input-container {
            padding: 20px;
            background-color: white;
            border-top: 1px solid var(--border-color);
        }
        
        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 15px;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
            max-height: 150px;
        }
        
        .chat-input:focus {
            border-color: var(--primary-color);
        }
        
        .send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .send-button:hover {
            background-color: #5558e3;
        }
        
        .send-button:disabled {
            background-color: #c7d2fe;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: none;
            padding: 15px;
        }
        
        .typing-indicator span {
            height: 10px;
            width: 10px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        .error-message {
            background-color: #fee2e2;
            color: #b91c1c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .error-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .quota-error {
            background-color: #fffbeb;
            color: #92400e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .quota-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quota-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .modal {
            display: none;
        }
        
        .modal.show {
            display: flex;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .message-content {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="bi bi-robot"></i>
                </div>
                <div>
                    <h1 class="app-title">AI Agent Tool</h1>
                    <p class="app-subtitle">Your intelligent assistant</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="status-badge status-demo" id="statusBadge">
                    <i class="bi bi-circle-fill"></i> Demo Mode
                </div>
                <button class="btn btn-sm btn-outline-primary" id="apiKeyBtn">
                    <i class="bi bi-key"></i> API Key
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="settingsButton">
                    <i class="bi bi-gear"></i>
                </button>
            </div>
        </header>
        
        <div class="main-content">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <button class="new-chat-btn" id="newChatBtn">
                        <i class="bi bi-plus-lg"></i> New Chat
                    </button>
                </div>
                <div class="chat-history" id="chatHistory">
                    <div class="chat-history-item active">
                        <i class="bi bi-chat-dots chat-history-icon"></i>
                        <div class="chat-history-title">Welcome to AI Agent</div>
                    </div>
                </div>
            </aside>
            
            <main class="chat-container">
                <div class="chat-header">
                    <h2 class="chat-title">
                        <i class="bi bi-chat-dots"></i>
                        Welcome to AI Agent
                    </h2>
                    <div class="model-selector" id="currentModel">Demo Mode</div>
                    <div class="chat-actions">
                        <button class="action-btn" title="Clear chat">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="action-btn" title="Export chat">
                            <i class="bi bi-download"></i>
                        </button>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon">
                            <i class="bi bi-robot"></i>
                        </div>
                        <h3 class="welcome-title">Welcome to AI Agent Tool</h3>
                        <p class="welcome-description">
                            Experience the power of AI with this intelligent assistant. Add your API key to connect to OpenAI's models or try the demo mode.
                        </p>
                        
                        <div class="feature-cards">
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="bi bi-lightning-charge"></i>
                                </div>
                                <h4 class="feature-title">Fast Responses</h4>
                                <p class="feature-description">Get quick and accurate answers to your questions</p>
                            </div>
                            
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="bi bi-shield-check"></i>
                                </div>
                                <h4 class="feature-title">Secure & Private</h4>
                                <p class="feature-description">Your data is processed securely and never stored</p>
                            </div>
                            
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="bi bi-gear"></i>
                                </div>
                                <h4 class="feature-title">Customizable</h4>
                                <p class="feature-description">Adjust settings to match your preferences</p>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-3">
                            <button class="btn btn-primary" id="getStartedBtn">
                                <i class="bi bi-play-circle me-2"></i> Get Started
                            </button>
                            <button class="btn btn-outline-primary" id="apiKeySetupBtn">
                                <i class="bi bi-key me-2"></i> Set Up API Key
                            </button>
                        </div>
                    </div>
                    
                    <div class="quota-error" id="quotaError">
                        <div class="quota-title">
                            <i class="bi bi-exclamation-triangle"></i> API Quota Exceeded
                        </div>
                        <p>You've exceeded your current API quota. This happens when you've reached the usage limit of your OpenAI plan.</p>
                        <div class="quota-actions">
                            <button class="btn btn-warning" id="upgradePlanBtn">
                                <i class="bi bi-credit-card me-2"></i> Upgrade Plan
                            </button>
                            <button class="btn btn-outline-secondary" id="switchToDemoBtn">
                                <i class="bi bi-arrow-repeat me-2"></i> Switch to Demo Mode
                            </button>
                        </div>
                    </div>
                    
                    <div class="typing-indicator" id="typingIndicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea class="chat-input" id="chatInput" placeholder="Type your message here..." rows="1"></textarea>
                        <button class="send-button" id="sendButton">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- API Key Modal -->
    <div class="modal fade" id="apiKeyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">OpenAI API Key</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="apiKeyInput" class="form-label">Enter your OpenAI API Key</label>
                        <input type="password" class="form-control" id="apiKeyInput" placeholder="sk-...">
                        <div class="form-text">Your API key is stored locally and never sent to any server except OpenAI.</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> You can get your API key from the OpenAI dashboard at platform.openai.com
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveApiKeyBtn">Save API Key</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modelSelect" class="form-label">AI Model</label>
                        <select class="form-select" id="modelSelect">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="systemPrompt" class="form-label">System Prompt</label>
                        <textarea class="form-control" id="systemPrompt" rows="3">You are a helpful assistant.</textarea>
                        <div class="form-text">Customize how the AI behaves by changing the system prompt.</div>
                    </div>
                    <div class="mb-3">
                        <label for="temperatureSlider" class="form-label">Creativity: <span id="temperatureValue">0.7</span></label>
                        <input type="range" class="form-range" id="temperatureSlider" min="0" max="1" step="0.1" value="0.7">
                        <div class="form-text">Higher values make the output more creative, lower values more focused.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i id="toastIcon" class="bi bi-info-circle-fill text-primary me-2"></i>
                <strong id="toastHeader" class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Notification message
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const statusBadge = document.getElementById('statusBadge');
            const currentModelBadge = document.getElementById('currentModel');
            const apiKeyBtn = document.getElementById('apiKeyBtn');
            const settingsButton = document.getElementById('settingsButton');
            const newChatBtn = document.getElementById('newChatBtn');
            const getStartedBtn = document.getElementById('getStartedBtn');
            const apiKeySetupBtn = document.getElementById('apiKeySetupBtn');
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const messagesContainer = document.getElementById('messagesContainer');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const typingIndicator = document.getElementById('typingIndicator');
            const quotaError = document.getElementById('quotaError');
            const upgradePlanBtn = document.getElementById('upgradePlanBtn');
            const switchToDemoBtn = document.getElementById('switchToDemoBtn');
            
            // Modal Elements
            const apiKeyModal = new bootstrap.Modal(document.getElementById('apiKeyModal'));
            const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
            const apiKeyInput = document.getElementById('apiKeyInput');
            const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
            const modelSelect = document.getElementById('modelSelect');
            const systemPrompt = document.getElementById('systemPrompt');
            const temperatureSlider = document.getElementById('temperatureSlider');
            const temperatureValue = document.getElementById('temperatureValue');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            
            // Toast Elements
            const toastNotification = new bootstrap.Toast(document.getElementById('toastNotification'));
            const toastMessage = document.getElementById('toastMessage');
            const toastHeader = document.getElementById('toastHeader');
            const toastIcon = document.getElementById('toastIcon');
            
            // State
            let apiKey = localStorage.getItem('openai_api_key') || '';
            let model = localStorage.getItem('openai_model') || 'gpt-3.5-turbo';
            let systemPromptText = localStorage.getItem('system_prompt') || 'You are a helpful assistant.';
            let temperature = parseFloat(localStorage.getItem('temperature')) || 0.7;
            let isDemoMode = !apiKey;
            let conversationHistory = [];
            let hasQuotaError = false;
            
            // Initialize UI
            updateUI();
            
            // Event Listeners
            apiKeyBtn.addEventListener('click', function() {
                apiKeyInput.value = apiKey;
                apiKeyModal.show();
            });
            
            settingsButton.addEventListener('click', function() {
                modelSelect.value = model;
                systemPrompt.value = systemPromptText;
                temperatureSlider.value = temperature;
                temperatureValue.textContent = temperature;
                settingsModal.show();
            });
            
            saveApiKeyBtn.addEventListener('click', function() {
                const newApiKey = apiKeyInput.value.trim();
                if (newApiKey) {
                    apiKey = newApiKey;
                    localStorage.setItem('openai_api_key', apiKey);
                    
                    // Update status
                    isDemoMode = false;
                    hasQuotaError = false;
                    updateUI();
                    
                    // Show success message
                    showToast('API key saved successfully!', 'Success', 'bi bi-check-circle-fill text-success');
                    
                    // Close modal
                    apiKeyModal.hide();
                }
            });
            
            saveSettingsBtn.addEventListener('click', function() {
                model = modelSelect.value;
                systemPromptText = systemPrompt.value;
                temperature = parseFloat(temperatureSlider.value);
                
                localStorage.setItem('openai_model', model);
                localStorage.setItem('system_prompt', systemPromptText);
                localStorage.setItem('temperature', temperature);
                
                updateUI();
                
                // Show success message
                showToast('Settings saved successfully!', 'Success', 'bi bi-check-circle-fill text-success');
                
                // Close modal
                settingsModal.hide();
            });
            
            temperatureSlider.addEventListener('input', function() {
                temperatureValue.textContent = this.value;
            });
            
            newChatBtn.addEventListener('click', function() {
                if (confirm('Start a new conversation? This will clear the current chat history.')) {
                    conversationHistory = [];
                    messagesContainer.innerHTML = '';
                    welcomeScreen.style.display = 'flex';
                    updateUI();
                }
            });
            
            getStartedBtn.addEventListener('click', function() {
                welcomeScreen.style.display = 'none';
                chatInput.focus();
            });
            
            apiKeySetupBtn.addEventListener('click', function() {
                apiKeyModal.show();
            });
            
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            upgradePlanBtn.addEventListener('click', function() {
                window.open('https://platform.openai.com/account/billing', '_blank');
            });
            
            switchToDemoBtn.addEventListener('click', function() {
                isDemoMode = true;
                hasQuotaError = false;
                updateUI();
                quotaError.style.display = 'none';
                showToast('Switched to Demo Mode', 'Info', 'bi bi-info-circle-fill text-primary');
            });
            
            // Auto-resize textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
                
                // Enable/disable send button
                sendButton.disabled = !this.value.trim();
            });
            
            function updateUI() {
                // Update status badge
                if (hasQuotaError) {
                    statusBadge.className = 'status-badge status-error';
                    statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> Quota Exceeded';
                } else if (isDemoMode) {
                    statusBadge.className = 'status-badge status-demo';
                    statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> Demo Mode';
                } else {
                    statusBadge.className = 'status-badge status-connected';
                    statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> Connected';
                }
                
                // Update model badge
                if (isDemoMode) {
                    currentModelBadge.textContent = 'Demo Mode';
                } else {
                    currentModelBadge.textContent = model;
                }
                
                // Enable/disable send button
                sendButton.disabled = !chatInput.value.trim();
            }
            
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Hide welcome screen if visible
                if (welcomeScreen.style.display !== 'none') {
                    welcomeScreen.style.display = 'none';
                }
                
                // Hide quota error if visible
                if (quotaError.style.display !== 'none') {
                    quotaError.style.display = 'none';
                }
                
                // Add user message to UI
                addMessageToUI('user', message);
                
                // Add to conversation history
                conversationHistory.push({
                    role: 'user',
                    content: message
                });
                
                // Clear input
                chatInput.value = '';
                chatInput.style.height = 'auto';
                
                // Show typing indicator
                typingIndicator.style.display = 'block';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Call API or demo mode
                if (isDemoMode || hasQuotaError) {
                    // Demo mode - simulate response after delay
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        const demoResponse = generateDemoResponse(message);
                        addMessageToUI('assistant', demoResponse);
                        
                        // Add to conversation history
                        conversationHistory.push({
                            role: 'assistant',
                            content: demoResponse
                        });
                    }, 1500);
                } else {
                    // Real API call
                    callOpenAIAPI();
                }
            }
            
            function addMessageToUI(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-avatar';
                avatarDiv.innerHTML = role === 'user' ? '<i class="bi bi-person-fill"></i>' : '<i class="bi bi-robot"></i>';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = content;
                
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);
                
                // Insert before typing indicator
                messagesContainer.insertBefore(messageDiv, typingIndicator);
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            async function callOpenAIAPI() {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                {
                                    role: 'system',
                                    content: systemPromptText
                                },
                                ...conversationHistory
                            ],
                            temperature: temperature,
                            max_tokens: 1000
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        
                        // Check for quota exceeded error
                        if (errorData.error?.code === 'insufficient_quota' || 
                            errorData.error?.message?.includes('quota') ||
                            errorData.error?.message?.includes('billing')) {
                            hasQuotaError = true;
                            updateUI();
                            
                            // Hide typing indicator
                            typingIndicator.style.display = 'none';
                            
                            // Show quota error message
                            quotaError.style.display = 'block';
                            
                            // Show notification
                            showToast('API quota exceeded. Please upgrade your plan or switch to demo mode.', 'Quota Exceeded', 'bi bi-exclamation-triangle-fill text-warning');
                            
                            return;
                        }
                        
                        throw new Error(errorData.error?.message || 'API request failed');
                    }
                    
                    const data = await response.json();
                    const assistantMessage = data.choices[0].message.content;
                    
                    // Add assistant message to conversation history
                    conversationHistory.push({
                        role: 'assistant',
                        content: assistantMessage
                    });
                    
                    // Hide typing indicator
                    typingIndicator.style.display = 'none';
                    
                    // Add assistant message to UI
                    addMessageToUI('assistant', assistantMessage);
                    
                } catch (error) {
                    console.error('Error calling OpenAI API:', error);
                    
                    // Hide typing indicator
                    typingIndicator.style.display = 'none';
                    
                    // Show error message
                    showToast(`Error: ${error.message}`, 'Error', 'bi bi-exclamation-triangle-fill text-danger');
                }
            }
            
            function generateDemoResponse(userMessage) {
                // Simple demo responses based on keywords
                const message = userMessage.toLowerCase();
                
                if (message.includes('hello') || message.includes('hi') || message.includes('hey')) {
                    return "Hello! I'm a demo AI assistant. I can provide basic responses, but for more advanced capabilities, please add your OpenAI API key in the settings.";
                }
                
                if (message.includes('help')) {
                    return "I'm here to help! You can ask me questions, and I'll do my best to answer. In this demo mode, my responses are limited. For full functionality, add your OpenAI API key.";
                }
                
                if (message.includes('thank')) {
                    return "You're welcome! Is there anything else I can help you with?";
                }
                
                if (message.includes('api key')) {
                    return "You can add your OpenAI API key by clicking the 'API Key' button in the top right corner. This will enable full functionality with advanced AI models.";
                }
                
                if (message.includes('demo')) {
                    return "Yes, you're currently using the demo mode. To access the full capabilities of this AI agent, you'll need to add your OpenAI API key.";
                }
                
                // Default response
                return "I understand you're asking about: '" + userMessage + "'. In demo mode, I can only provide limited responses. To get more detailed and accurate answers, please add your OpenAI API key in the settings.";
            }
            
            function showToast(message, header, iconClass) {
                toastMessage.textContent = message;
                toastHeader.textContent = header;
                toastIcon.className = iconClass + ' me-2';
                toastNotification.show();
            }
        });
    </script>
</body>
</html>
